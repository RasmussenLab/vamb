## Running Vamb
Most users will want to copy and change the commands from the quickstart section below.
Users with more advanced data, or who really wants to dig into Vamb to get the most out of Vamb should read the in-depth sections below.

First figure out what you want to run:
* Do you have contigs plus reads plus a taxonomic annotation of the contigs? Use __TaxVamb__
* Do you only have contigs plus reads and want a decent, fast binner? Use __Vamb__

We also support the __AVAMB__ binner. It's performance is in between TaxVamb and Vamb,
but it requires more compute than either.
I recommend new users run either TaxVamb or Vamb.

### Quickstart
#### Vamb
```shell
$ # Assemble your reads, one assembly per sample, e.g. with SPAdes
$ for sample in 1 2 3; do
      spades.py --meta ${sample}.{fw,rv}.fq.gz  -t 24 -m 100gb -o asm_${sample};
  done    

$ # Concatenate your assemblies, and rename the contigs to the naming scheme
$ # S{sample}C{original contig name}. This can be done with a script provided by Vamb:
$ python concatenate.py contigs.fna.gz asm_{1,2,3}/contigs.fasta

$ # Estimate sample-wise abundance by mapping reads to the contigs.
$ # Any mapper will do, but we recommend strobealign with the --aemb flag
$ mkdir aemb
$ for sample in 1 2 3; do
      strobealign -t 8 --aemb contigs.fna.gz ${sample}.{fw,rv}.fq.gz > aemb/${sample}.tsv;
  done

$ # Paste the aemb files together to make a TSV file with given header
$ cat <(echo -e "contigname\t1\t2\t3") paste aemb/1.tsv <(cut -f 2 aemb/2.tsv) <(cut -f 2 aemb/3.tsv) > abundance.tsv

$ # Run Vamb using the contigs and the directory with abundance files
$ vamb bin default --outdir vambout --fasta contigs.fna.gz --abundance_tsv abundance.tsv
```

#### TaxVamb
```shell
$ vamb bin taxvamb --outdir path/to/outdir --fasta /path/to/catalogue.fna.gz --abundance_tsv abundance.tsv --taxonomy taxonomy.tsv
```

The FASTA and abundance preprocessing intructions are the same as for running default VAMB.

In addition to that, TaxVAMB requires a taxonomic annotation file (refined or unrefined) containing all contigs.
See the description of the taxonomy input in the section on inputs below.

#### AVAMB
See the README.md file in the `workflow_avamb` directory.

### The different Vamb inputs
All modes of Vamb takes various _inputs_ and produces various _outputs_.
Currently, all modes take the following two central inputs:

* The kmer-composition of the sequence (the _composition_).
* The abundance of the contigs in each sample (the _abundance_).

For inputs that take significant time to produce, Vamb will serialize the parsed input to a file, such that future runs of Vamb can use that instead of re-computing it.

#### Composition
The composition is computed from the input contig file in FASTA format (the 'catalogue').
From command line, this looks like:

```shell
--fasta contigs.fna.gz
```

Where the catalogue may be either gzipped or a plain file.
When parsed, Vamb will write the composition in the output file `composition.npz`.
Future runs can then instead use:

```shell
--composition composition.npz
```

#### Abundance
The abundance may be computed from either:
* A TSV file with the header being "contigname" followed by one samplename per sample,
  and the values in the TSV file being precomputed abundances.
  These may be derived from `paste`ing together outputs from the tool `strobealign --aemb`
* A directory of sorted BAM files generated by mapping the reads of each sample to the contig catalogue (see above).

Thus, it can be specified as:
```shell
--abundance_tsv abundance.tsv
```
or
```shell
--bamdir dir_with_bam_files
```

When parsed, Vamb will produce the file `abundance.npz`, which can be used for future
Vamb runs instead:
```
--abundance abundance.npz
```

__Note:__ Vamb will check that the sequence names in the TSV / BAM files correspond
to the names in the composition.

### Taxonomy
Vamb operates with two kinds of taxonomies:
* _Unrefined_ taxonomies give the taxonomic annotation for each contig
* _Refined_ taxonomies gives the taxonomic annotation _plus a probability estimate_ for each contig

Vamb's __Taxometer__ tool can be used to refine a taxonomy.
Both refined and unrefined taxonomies can be used for TaxVamb.
By default, if TaxVamb gets an unrefined taxonomy, it will refine it with Taxometer, unless `--no_predict` is passed.

Taxonomy files are TSV files with the following format:
* Header: `contigs\tpredictions` for unrefined taxonomies and `contigs\tpredictions\tscores` for refined ones.
* In the `contigs` column: The FASTA identifier for every contig in the catalogue
* In the `predictions` column: A semicolon-separated string with taxonomic levels, for each of the following seven ranks, in order:
  domain, phylum, class, order, family, genus, species. Lower ranks may be omitted.
  There is no requirement that the labels are actually meaningful, i.e. that they correspond to any real taxonomic clade.
* In the `scores` column: A semicolon separated list of floats, one per element in the `predictions` column.

The following are examples of VALID prediction columns:
```
Bacteria;Bacillota;Clostridia
Bacteria;Bacillota;Bacilli;Bacillales
Bacteria;Pseudomonadota;Gammaproteobacteria;Moraxellales;Moraxellaceae;Acinetobacter;Acinetobacter sp. TTH0-4
```

The following are example of INVALID prediction columns:
* Invalid: Begins with class instead of domain: `Clostridia;Eubacteriales;Lachnospiraceae;Roseburia;Roseburia hominis`
* Invalid: Skips the phylum: `Bacteria;Gammaproteobacteria;Moraxellales;Moraxellaceae;Acinetobacter;Acinetobacter sp. TTH0-4`

The following is an example of a valid, unrefined taxonomy file:
```
contigs	predictions
S18C13	Bacteria;Bacillota;Clostridia;Eubacteriales
S18C25	Bacteria;Pseudomonadota
S18C67	Bacteria;Bacillota;Bacilli;Bacillales;Staphylococcaceae;Staphylococcus
```

Our tool  __Taxconverter__ https://github.com/RasmussenLab/taxconverter can be used to create unrefined taxonomy files from MMSeqs2, Centrifuge, Kraken2, Metabuli or MetaMaps output files.